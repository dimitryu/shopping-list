<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperList Pro 2.0</title>
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #3367D6;
            --success-color: #34A853;
            --danger-color: #EA4335;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 600px; background: var(--card-bg); min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; }
        
        header { background-color: var(--primary-color); color: white; padding: 1rem; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .header-title { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        
        #auth-btn { background: white; color: #444; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .refresh-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .hidden { display: none !important; }
        .content { padding: 15px; flex: 1; padding-bottom: 100px; }
        
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: #f8faff; }
        
        .item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .item:active { background-color: #f5f5f5; }
        
        .item-main { display: flex; align-items: center; flex: 1; cursor: pointer; gap: 12px; }
        
        /* Checkbox Customization */
        .checkbox { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .checkbox.checked { background-color: var(--success-color); border-color: var(--success-color); }
        .checkbox.checked::after { content: 'âœ“'; color: white; font-size: 14px; font-weight: bold; }
        
        /* Quantity Controls */
        .qty-control { display: flex; align-items: center; background: #f0f2f5; border-radius: 8px; padding: 2px; margin-left: 10px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: white; border-radius: 6px; cursor: pointer; color: var(--primary-color); font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .qty-val { min-width: 20px; text-align: center; font-size: 14px; font-weight: 600; margin: 0 5px; }
        
        /* Shopping Mode Styles */
        .item.bought { background-color: #fafafa; }
        .item.bought span { text-decoration: line-through; color: #aaa; }
        .item.bought .checkbox { background-color: #ddd; border-color: #ddd; }
        .item.bought .qty-control { opacity: 0.5; pointer-events: none; }

        .category-header { background-color: #e8f0fe; color: var(--primary-color); padding: 8px 12px; margin-top: 20px; margin-bottom: 5px; border-radius: 8px; font-weight: bold; font-size: 0.9em; letter-spacing: 0.5px; }
        
        .fab-btn { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; background: var(--primary-color); color: white; border-radius: 50%; border: none; font-size: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4); transition: transform 0.2s; z-index: 99; }
        .fab-btn:active { transform: scale(0.95); }

        .actions-bar { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .action-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-clear-bought { background-color: #ffebee; color: var(--danger-color); }
        .btn-clear-all { background-color: #eee; color: #666; font-size: 14px; padding: 10px;}

        /* Modal */
        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 16px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; color: #444; }
        .modal input, .modal select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; }
        .modal input:focus, .modal select:focus { border-color: var(--primary-color); }
        .modal-btn { width: 100%; padding: 12px; margin-top: 8px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .save-btn { background: var(--primary-color); color: white; }
        .delete-btn { background: #ffebee; color: var(--danger-color); }
        .cancel-btn { background: transparent; color: #888; margin-top: 0; }

        .status-bar { font-size: 12px; background: rgba(0,0,0,0.1); padding: 4px 10px; border-radius: 10px; color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-top">
            <div class="header-title">ğŸ›’ SuperList Pro</div>
            <button class="refresh-btn" onclick="syncNow()" title="×¨×¢× ×Ÿ × ×ª×•× ×™×">ğŸ”„</button>
        </div>
        
        <button id="auth-btn" onclick="handleAuthClick()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="G" width="18">
            ×”×ª×—×‘×¨ ×¢× Google
        </button>
        <button id="signout-btn" onclick="handleSignoutClick()" class="hidden" style="background:none; border:1px solid rgba(255,255,255,0.5); color:white; cursor:pointer; padding:4px 10px; border-radius:15px; font-size:12px;">×”×ª× ×ª×§</button>
        <div id="status-msg" class="status-bar">×××ª×™×Ÿ ×œ×”×ª×—×‘×¨×•×ª...</div>
    </header>

    <div id="app-content" class="hidden">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('catalog')">ğŸ  ×ª×›× ×•×Ÿ</div>
            <div class="tab" onclick="switchTab('shopping')">ğŸƒ ×§× ×™×” ×‘×¡×•×¤×¨</div>
        </div>

        <div id="view-catalog" class="content">
            <div id="catalog-list-container"></div>
        </div>

        <div id="view-shopping" class="content hidden">
            <div id="shopping-list-container"></div>
            
            <div class="actions-bar">
                <button class="action-btn btn-clear-bought" onclick="clearBoughtItems()">
                    ğŸ—‘ï¸ × ×§×” ××•×¦×¨×™× ×©× ×§× ×•
                </button>
                <button class="action-btn btn-clear-all" onclick="clearAllList()">
                    âš ï¸ ××¤×¡ ××ª ×›×œ ×”×¨×©×™××”
                </button>
            </div>
        </div>
        
        <button class="fab-btn" onclick="openAddModal()">+</button>
    </div>
</div>

<div id="edit-modal" class="modal-overlay hidden">
    <div class="modal">
        <h3 id="modal-title">××•×¦×¨</h3>
        <input type="text" id="modal-name-input" placeholder="×©× ×”××•×¦×¨..." autocomplete="off">
        <select id="modal-category-input">
            <option value="×›×œ×œ×™">×›×œ×œ×™</option>
            <option value="×™×¨×§×•×ª ×•×¤×™×¨×•×ª">×™×¨×§×•×ª ×•×¤×™×¨×•×ª ğŸ…</option>
            <option value="××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×">×—×œ×‘ ×•×‘×™×¦×™× ğŸ§€</option>
            <option value="×œ×—× ×•×××¤×™×">×œ×—× ×•×××¤×™× ğŸ</option>
            <option value="×‘×©×¨ ×•×“×’×™×">×‘×©×¨ ×•×“×’×™× ğŸ¥©</option>
            <option value="××–×•×•×” ×•×‘×™×©×•×œ">××–×•×•×” ×•×‘×™×©×•×œ ğŸ</option>
            <option value="× ×™×§×™×•×Ÿ ×•×‘×™×ª">× ×™×§×™×•×Ÿ ×•×‘×™×ª ğŸ§¹</option>
        </select>
        <button class="modal-btn save-btn" onclick="handleModalSave()">×©××•×¨</button>
        <button class="modal-btn delete-btn hidden" id="modal-delete-btn" onclick="deleteItem()">××—×§ ××•×¦×¨</button>
        <button class="modal-btn cancel-btn" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
</div>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
    // ==========================================
    // *** ×—×•×‘×” ×œ××œ× ××ª ×”×¤×¨×˜×™× ×©×œ×š ×›××Ÿ! ***
    // ==========================================
    const CLIENT_ID = '259426164274-8vbv26e89kerdjv4q4gc612rht8sqng9.apps.googleusercontent.com'; // ×”×“×‘×§ ×›××Ÿ
    const API_KEY = 'AIzaSyB9PVroJWU0ynWjfVMa_0iWYZWd0JLTboM'; // ×”×“×‘×§ ×›××Ÿ (×–×” ×©××ª×—×™×œ ×‘-AIza)
    // ==========================================

    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FILE_NAME = 'superlist_data.json';
    
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let driveFileId = null;
    let products = [];

    // --- Google Init ---
    function gapiLoaded() {
        gapi.load('client', async () => {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [], });
                await gapi.client.load('drive', 'v3');
                gapiInited = true;
                checkAuth();
            } catch (err) {
                console.error('Error loading GAPI:', err);
                document.getElementById('status-msg').innerText = '×©×’×™××ª API - ×‘×“×•×§ ××¤×ª×—×•×ª';
            }
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '',
        });
        gisInited = true;
        checkAuth();
    }

    function checkAuth() {
        if (gapiInited && gisInited) {
            document.getElementById('auth-btn').style.display = 'flex';
        }
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            showApp();
            await findOrCreateFile();
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('auth-btn').classList.remove('hidden');
            document.getElementById('signout-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = '×××ª×™×Ÿ ×œ×”×ª×—×‘×¨×•×ª...';
            products = [];
        }
    }

    function showApp() {
        document.getElementById('auth-btn').classList.add('hidden');
        document.getElementById('signout-btn').classList.remove('hidden');
        document.getElementById('app-content').classList.remove('hidden');
    }

    // --- Drive Logic ---
    async function findOrCreateFile() {
        document.getElementById('status-msg').innerText = '××¡×ª× ×›×¨×Ÿ...';
        try {
            const response = await gapi.client.drive.files.list({
                q: `name = '${FILE_NAME}' and trashed = false`,
                fields: 'files(id, name)', spaces: 'drive'
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                driveFileId = files[0].id;
                await loadFileContent();
            } else {
                await createNewFile();
            }
        } catch (err) {
            console.error(err);
            document.getElementById('status-msg').innerText = '×©×’×™××ª ×—×™×‘×•×¨ ×œ×“×¨×™×™×‘';
        }
    }

    async function createNewFile() {
        const initialData = JSON.stringify([]);
        const metadata = { name: FILE_NAME, mimeType: 'application/json' };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([initialData], { type: 'application/json' }));
        const accessToken = gapi.client.getToken().access_token;
        const fetchResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }), body: form
        });
        const file = await fetchResponse.json();
        driveFileId = file.id;
        products = [];
        renderCatalog();
        document.getElementById('status-msg').innerText = '××—×•×‘×¨ âœ…';
    }

    async function loadFileContent() {
        try {
            document.getElementById('status-msg').innerText = '×˜×•×¢×Ÿ...';
            const response = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
            products = response.result || [];
            if (typeof products !== 'object') products = [];
            
            // ×”××¨×ª × ×ª×•× ×™× ×™×©× ×™× (×× ×—×¡×¨ ×©×“×” ×›××•×ª)
            products.forEach(p => { if(!p.qty) p.qty = 1; });

            refreshView();
            document.getElementById('status-msg').innerText = '××¢×•×“×›×Ÿ âœ…';
        } catch (err) {
            console.error(err);
            document.getElementById('status-msg').innerText = '×©×’×™××” ×‘×˜×¢×™× ×”';
        }
    }

    async function saveToDrive() {
        if (!driveFileId) return;
        document.getElementById('status-msg').innerText = '×©×•××¨... â³';
        const content = JSON.stringify(products);
        const accessToken = gapi.client.getToken().access_token;
        try {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' }),
                body: content
            });
            document.getElementById('status-msg').innerText = '× ×©××¨ âœ…';
        } catch (err) {
            console.error('Error saving', err);
            document.getElementById('status-msg').innerText = '×©×’×™××” ×‘×©××™×¨×” âŒ';
        }
    }

    function syncNow() {
        if(driveFileId) loadFileContent();
    }

    // --- App Logic ---
    const CATEGORIES = ["×™×¨×§×•×ª ×•×¤×™×¨×•×ª", "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", "×œ×—× ×•×××¤×™×", "×‘×©×¨ ×•×“×’×™×", "××–×•×•×” ×•×‘×™×©×•×œ", "× ×™×§×™×•×Ÿ ×•×‘×™×ª", "×›×œ×œ×™"];

    function refreshView() {
        const isShopping = document.querySelectorAll('.tab')[1].classList.contains('active');
        if(isShopping) renderShoppingList(); else renderCatalog();
    }

    function switchTab(tab) {
        document.getElementById('view-catalog').classList.add('hidden');
        document.getElementById('view-shopping').classList.add('hidden');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        if(tab === 'catalog') {
            document.getElementById('view-catalog').classList.remove('hidden');
            document.querySelectorAll('.tab')[0].classList.add('active');
            renderCatalog();
        } else {
            document.getElementById('view-shopping').classList.remove('hidden');
            document.querySelectorAll('.tab')[1].classList.add('active');
            renderShoppingList();
        }
    }

    function renderCatalog() {
        const container = document.getElementById('catalog-list-container');
        container.innerHTML = '';
        const groups = {};
        CATEGORIES.forEach(c => groups[c] = []);
        products.forEach(p => {
            const cat = p.category || '×›×œ×œ×™';
            if(!groups[cat]) groups[cat] = [];
            groups[cat].push(p);
        });

        CATEGORIES.forEach(cat => {
            if(groups[cat].length > 0) {
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerText = cat;
                container.appendChild(header);
                
                // Sort: Selected first
                groups[cat].sort((a,b) => (a.isSelected === b.isSelected) ? 0 : a.isSelected ? -1 : 1);

                groups[cat].forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div class="item-main" onclick="toggleSelect(${p.id})">
                            <div class="checkbox ${p.isSelected ? 'checked' : ''}"></div>
                            <span>${p.name}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                             <div class="qty-control" onclick="event.stopPropagation()">
                                <button class="qty-btn" onclick="updateQty(${p.id}, -1)">-</button>
                                <span class="qty-val">${p.qty || 1}</span>
                                <button class="qty-btn" onclick="updateQty(${p.id}, 1)">+</button>
                            </div>
                            <button onclick="openEditModal(${p.id})" style="border:none; background:none; cursor:pointer; font-size:18px; color:#ccc; margin-right:5px;">âœ</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        });
    }

    function renderShoppingList() {
        const container = document.getElementById('shopping-list-container');
        container.innerHTML = '';
        
        // Filter active items
        let list = products.filter(p => p.isSelected);
        
        // SORT: Unbought first, Bought last
        list.sort((a,b) => {
            if (a.isBought === b.isBought) return 0;
            return a.isBought ? 1 : -1;
        });
        
        if(list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; margin-top:30px;">×”×¨×©×™××” ×¨×™×§×” ğŸ‰<br>×¢×‘×•×¨ ×œ××¡×š ×”×ª×›× ×•×Ÿ ×›×“×™ ×œ×”×•×¡×™×£ ××•×¦×¨×™×</div>';
            return;
        }

        const groups = {}; 
        list.forEach(p => {
            const cat = p.category || '×›×œ×œ×™';
            if(!groups[cat]) groups[cat] = [];
            groups[cat].push(p);
        });

        // We render based on CATEGORIES order, but strictly following the Sort order we just did isn't possible with categories grouping.
        // So we will render Categories, but inside each category, sort bought last.
        
        let hasItems = false;
        CATEGORIES.forEach(cat => {
            if(groups[cat] && groups[cat].length > 0) {
                hasItems = true;
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerText = cat;
                container.appendChild(header);
                
                // Inside category: Not Bought First
                groups[cat].sort((a,b) => (a.isBought === b.isBought) ? 0 : a.isBought ? 1 : -1);

                groups[cat].forEach(p => {
                    const div = document.createElement('div');
                    div.className = `item ${p.isBought ? 'bought' : ''}`;
                    div.innerHTML = `
                        <div class="item-main" onclick="toggleBought(${p.id})">
                            <div class="checkbox ${p.isBought ? 'checked' : ''}"></div>
                            <span>${p.name}</span>
                        </div>
                        <div class="qty-control">
                            <span class="qty-val" style="margin:0 8px;">${p.qty || 1} ×™×—'</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        });
    }

    // --- Actions ---

    function toggleSelect(id) {
        const p = products.find(x => x.id === id);
        if(p) { 
            p.isSelected = !p.isSelected; 
            if(!p.isSelected) p.isBought = false; 
            saveToDrive(); 
            refreshView(); 
        }
    }

    function toggleBought(id) {
        const p = products.find(x => x.id === id);
        if(p) { 
            p.isBought = !p.isBought; 
            saveToDrive(); 
            // Small delay to let user see the checkmark before moving
            setTimeout(() => refreshView(), 300);
        }
    }

    function updateQty(id, change) {
        const p = products.find(x => x.id === id);
        if(p) {
            let newQty = (p.qty || 1) + change;
            if(newQty < 1) newQty = 1;
            p.qty = newQty;
            saveToDrive();
            refreshView();
        }
    }

    // Modal Logic
    let currentEditId = null;
    function openAddModal() { 
        currentEditId = null; 
        document.getElementById('modal-name-input').value = ''; 
        document.getElementById('modal-delete-btn').classList.add('hidden'); 
        document.getElementById('edit-modal').classList.remove('hidden'); 
        setTimeout(() => document.getElementById('modal-name-input').focus(), 100);
    }
    
    function openEditModal(id) { 
        const p = products.find(x => x.id === id);
        if(!p) return;
        currentEditId = id; 
        document.getElementById('modal-name-input').value = p.name;
        document.getElementById('modal-category-input').value = p.category || '×›×œ×œ×™';
        document.getElementById('modal-delete-btn').classList.remove('hidden'); 
        document.getElementById('edit-modal').classList.remove('hidden'); 
    }
    
    function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }

    function handleModalSave() {
        const name = document.getElementById('modal-name-input').value;
        const cat = document.getElementById('modal-category-input').value;
        if(!name) return;

        if(currentEditId) {
            const p = products.find(x => x.id === currentEditId);
            p.name = name; p.category = cat;
        } else {
            // Check duplicate
            if(products.some(x => x.name === name)) { alert('×”××•×¦×¨ ×§×™×™×'); return; }
            products.push({ id: Date.now(), name: name, category: cat, isSelected: true, isBought: false, qty: 1 });
        }
        saveToDrive();
        closeModal();
        refreshView();
    }

    function deleteItem() {
        if(currentEditId && confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª?')) {
            products = products.filter(x => x.id !== currentEditId);
            saveToDrive();
            closeModal();
            refreshView();
        }
    }

    // --- Bulk Actions ---
    
    function clearBoughtItems() {
        // Unselect items that are bought
        let changed = false;
        products.forEach(p => {
            if(p.isSelected && p.isBought) {
                p.isSelected = false;
                p.isBought = false;
                p.qty = 1; // Reset qty for next time
                changed = true;
            }
        });
        
        if(changed) {
            saveToDrive();
            switchTab('catalog'); // Go back to catalog
        } else {
            alert('××™×Ÿ ××•×¦×¨×™× ××¡×•×× ×™× ×©× ×¨×›×©×•');
        }
    }

    function clearAllList() {
        if(confirm('×”×× ×œ××¤×¡ ××ª ×›×œ ×”×¨×©×™××”?')) {
            products.forEach(p => { 
                p.isSelected = false; 
                p.isBought = false; 
                p.qty = 1; 
            });
            saveToDrive();
            switchTab('catalog');
        }
    }
</script>
</body>
</html>
