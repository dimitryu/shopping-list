<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperList Pro 4.6 - Sync Fix</title>
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #3367D6;
            --success-color: #34A853;
            --danger-color: #EA4335;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --cart-header-bg: #e0e0e0;
            --star-color: #f1c40f;
            --star-inactive: #e0e0e0;
            --header-bg: #4285F4;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 600px; background: var(--card-bg); min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; }
        
        .sticky-header-container { position: sticky; top: 0; z-index: 100; background-color: var(--card-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        header { 
            background-color: var(--header-bg); color: white; padding: 0.5rem 1rem;
            display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 10px; 
        }

        .header-title-area { display: flex; align-items: center; gap: 8px; flex: 1; }
        .header-title { font-size: 1.1rem; font-weight: bold; white-space: nowrap; }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        
        .icon-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:active { background: rgba(255,255,255,0.4); }
        
        #auth-btn { background: white; color: #444; border: none; padding: 6px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #auth-btn img, #auth-btn svg { display: block; width: 16px; height: 16px; }

        .hidden { display: none !important; }
        .content { padding: 15px; flex: 1; padding-bottom: 50px; }
        
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px 5px; text-align: center; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: 0.2s; font-size: 0.9rem; }
        .tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: #f8faff; }

        /* Search Bar & Collapse Button */
        .search-row { display: flex; align-items: center; padding: 10px; background: #fff; border-bottom: 1px solid #eee; gap: 10px; }
        .search-container { flex: 1; }
        #search-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; transition: border-color 0.2s; }
        #search-input:focus { border-color: var(--primary-color); }
        
        .collapse-btn { background: #f0f2f5; border: 1px solid #ddd; color: #555; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .collapse-btn:active { background: #e0e0e0; }

        .item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; background: white; }
        .item:active { background-color: #f5f5f5; }
        .item-main { display: flex; align-items: center; flex: 1; cursor: pointer; gap: 12px; }
        
        .checkbox { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .checkbox.checked { background-color: var(--success-color); border-color: var(--success-color); }
        .checkbox.checked::after { content: 'âœ“'; color: white; font-size: 14px; font-weight: bold; }
        
        .star-check { width: 28px; height: 28px; font-size: 26px; color: var(--star-inactive); display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .star-check.active { color: var(--star-color); text-shadow: 0 2px 5px rgba(241, 196, 15, 0.4); }

        .user-badge { font-size: 10px; background-color: #e0e0e0; color: #555; width: 18px; height: 18px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-right: -5px; border: 1px solid #fff; }
        .base-indicator { font-size: 14px; color: var(--star-color); margin-left: 4px; }

        .qty-control { display: flex; align-items: center; background: #f0f2f5; border-radius: 8px; padding: 2px; margin-left: 10px; }
        .qty-btn { width: 26px; height: 26px; border: none; background: white; border-radius: 6px; cursor: pointer; color: var(--primary-color); font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .qty-input-manual { width: 40px; text-align: center; font-size: 14px; font-weight: 600; margin: 0 2px; border: none; background: transparent; outline: none; color: #333; font-family: inherit; }
        
        .item.bought { background-color: #fafafa; }
        .item.bought span { text-decoration: line-through; color: #aaa; }
        .item.bought .checkbox { background-color: #ddd; border-color: #ddd; }
        .item.bought .qty-control { opacity: 0.5; pointer-events: none; }

        .category-header { background-color: #e8f0fe; color: var(--primary-color); padding: 10px 12px; margin-top: 15px; margin-bottom: 5px; border-radius: 8px; font-weight: bold; font-size: 0.95em; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .category-header:hover { background-color: #dbe8fc; }
        .arrow-icon { transition: transform 0.2s; font-size: 0.8em; }
        .arrow-icon.closed { transform: rotate(90deg); }
        .category-items-container.closed { display: none; }
        .cart-header { background-color: var(--cart-header-bg); color: #555; }

        .actions-bar { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;}
        .action-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-clear-bought { background-color: #ffebee; color: var(--danger-color); }
        .btn-reset-plan { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .btn-add-base { background-color: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); }
        .btn-id-copy { background-color: #607d8b; color: white; font-size: 13px; padding: 10px; opacity: 0.9; margin-top: 10px; }

        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 16px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; color: #444; }
        .modal input, .modal select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; }
        .modal input:focus, .modal select:focus { border-color: var(--primary-color); }
        .modal-btn { width: 100%; padding: 12px; margin-top: 8px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .save-btn { background: var(--primary-color); color: white; }
        .delete-btn { background: #ffebee; color: var(--danger-color); }
        .cancel-btn { background: transparent; color: #888; margin-top: 0; }

        .status-bar { font-size: 11px; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; color: white; white-space: nowrap; margin-right: auto;}
    </style>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3081/3081840.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081840.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuperList">
    <meta name="theme-color" content="#4285F4">
</head>
<body>

<div class="app-container">
    <div class="sticky-header-container">
        <header>
            <div class="header-title-area">
                <span style="font-size: 1.4rem;">ğŸ›’</span>
                <div class="header-title">SuperList Pro</div>
                <div id="status-msg" class="status-bar">×××ª×™×Ÿ...</div>
            </div>
            
            <div class="header-actions">
                <button id="auth-btn" onclick="handleAuthClick()">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                    </svg>
                    ×”×ª×—×‘×¨
                </button>
                <button id="signout-btn" onclick="handleSignoutClick()" class="hidden icon-btn" title="×”×ª× ×ª×§">ğŸ›‘</button>
                <button class="icon-btn" onclick="openAddModal()" title="×”×•×¡×£ ××•×¦×¨ ×—×“×©">â•</button>
                <button class="icon-btn" onclick="syncNow()" title="×¨×¢× ×Ÿ × ×ª×•× ×™×">ğŸ”„</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab" onclick="switchTab('base')">â­ ×§×‘×•×¢×™×</div>
            <div class="tab active" onclick="switchTab('catalog')">ğŸ  ×ª×›× ×•×Ÿ</div>
            <div class="tab" onclick="switchTab('shopping')">ğŸƒ ×§× ×™×”</div>
        </div>
        
        <div class="search-row">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ğŸ” ×—×¤×© ××•×¦×¨..." onkeyup="handleSearch(this.value)">
            </div>
            <button class="collapse-btn" onclick="toggleCollapseAll()" title="×›×•×•×¥/×”×¨×—×‘ ×”×›×œ">â†•ï¸</button>
        </div>
    </div>

    <div id="app-content" class="hidden">
        
        <div id="view-base" class="content hidden">
            <div class="actions-bar">
                <button class="action-btn btn-add-base" onclick="addBaseToPlan()">
                    ğŸ“¥ ×”×›× ×¡ ××•×¦×¨×™× ××¡×•×× ×™× (â˜…) ×œ×ª×›× ×•×Ÿ
                </button>
            </div>
            <p style="text-align:center; color:#888; font-size:0.9em;">×œ×—×™×¦×” ×¢×œ ×›×•×›×‘ ××¡×× ×ª ×œ×”×¢×‘×¨×”.</p>
            <div id="base-list-container"></div>
        </div>

        <div id="view-catalog" class="content">
            <div id="catalog-list-container"></div>
            
            <div class="actions-bar">
                <button class="action-btn btn-reset-plan" onclick="resetPlanningList()">
                    â™»ï¸ × ×§×” ××ª ×”×ª×›× ×•×Ÿ (×—×“×© ×©×‘×•×¢)
                </button>
                
                <button class="action-btn btn-id-copy" onclick="copyFileId()">
                    ğŸ†” ×”×¢×ª×§ ××–×”×” ×¨×©×™××” (×œ×©×™×ª×•×£ ×¢× ××—×¨×™×)
                </button>
            </div>
        </div>

        <div id="view-shopping" class="content hidden">
            <div id="shopping-list-container"></div>
            
            <div class="actions-bar">
                <button class="action-btn btn-clear-bought" onclick="clearBoughtItems()">
                    ğŸ—‘ï¸ × ×§×” ××•×¦×¨×™× ×©× ×§× ×•
                </button>
                <button class="action-btn btn-reset-plan" onclick="resetPlanningList()">
                    ğŸ ×¡×™×™××ª×™ ×§× ×™×•×ª (××¤×¡ ×”×›×œ)
                </button>
            </div>
        </div>
    </div>
</div>

<div id="edit-modal" class="modal-overlay hidden">
    <div class="modal">
        <h3 id="modal-title">××•×¦×¨</h3>
        <input type="text" id="modal-name-input" placeholder="×©× ×”××•×¦×¨..." autocomplete="off">
        <select id="modal-category-input">
            <option value="×›×œ×œ×™">×›×œ×œ×™</option>
            <option value="×™×¨×§×•×ª ×•×¤×™×¨×•×ª">×™×¨×§×•×ª ×•×¤×™×¨×•×ª ğŸ…</option>
            <option value="××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×">×—×œ×‘ ×•×‘×™×¦×™× ğŸ§€</option>
            <option value="×œ×—× ×•×××¤×™×">×œ×—× ×•×××¤×™× ğŸ</option>
            <option value="×‘×©×¨ ×•×“×’×™×">×‘×©×¨ ×•×“×’×™× ğŸ¥©</option>
            <option value="××–×•×•×” ×•×‘×™×©×•×œ">××–×•×•×” ×•×‘×™×©×•×œ ğŸ</option>
            <option value="×©×™××•×¨×™×">×©×™××•×¨×™× ğŸ¥«</option>
            <option value="×—×˜×™×¤×™× ×•×××ª×§×™×">×—×˜×™×¤×™× ×•×××ª×§×™× ğŸ«</option>
            <option value="××©×§××•×ª ×§×œ×™×">××©×§××•×ª ×§×œ×™× ğŸ¥¤</option>
            <option value="××œ×›×•×”×•×œ">××œ×›×•×”×•×œ ğŸ·</option>
            <option value="× ×™×§×™×•×Ÿ ×•×‘×™×ª">× ×™×§×™×•×Ÿ ×•×‘×™×ª ğŸ§¹</option>
        </select>
        <button class="modal-btn save-btn" onclick="handleModalSave()">×©××•×¨</button>
        <button class="modal-btn delete-btn hidden" id="modal-delete-btn" onclick="deleteItem()">××—×§ ××•×¦×¨</button>
        <button class="modal-btn cancel-btn" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
</div>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
    // ==========================================
    // *** ×—×•×‘×” ×œ××œ× ××ª ×”×¤×¨×˜×™× ×©×œ×š ×›××Ÿ! ***
	// ==========================================
    const CLIENT_ID = '259426164274-8vbv26e89kerdjv4q4gc612rht8sqng9.apps.googleusercontent.com'; // ×œ×”×—×œ×™×£
    const API_KEY = 'AIzaSyB9PVroJWU0ynWjfVMa_0iWYZWd0JLTboM'; // ×œ×”×—×œ×™×£
    // ==========================================
    // ×›××Ÿ ××“×‘×™×§×™× ××ª ×”-ID ××—×¨×™ ×©×”×¢×ª×§×ª ××•×ª×• (×¨×§ ×œ××©×ª××©×™× ×”××©× ×™×™×)
    const MANUAL_FILE_ID = ''; 
    // ==========================================

    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile';
    const FILE_NAME = 'superlist_data.json';
    
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let driveFileId = null;
    let products = [];
    let categoryState = {}; 
    let allCollapsed = false;
    let currentUserInitial = '';
    let searchTerm = '';

    function gapiLoaded() {
        gapi.load('client', async () => {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [], });
                await gapi.client.load('drive', 'v3');
                gapiInited = true;
                checkAuth();
            } catch (err) {
                console.error('Error loading GAPI:', err);
                document.getElementById('status-msg').innerText = '×©×’×™××ª API';
            }
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '',
        });
        gisInited = true;
        checkAuth();
    }

    function checkAuth() {
        if (gapiInited && gisInited) {
            document.getElementById('auth-btn').style.display = 'flex';
        }
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            try {
                const userInfo = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${resp.access_token}` }
                }).then(res => res.json());
                if (userInfo.given_name) currentUserInitial = userInfo.given_name.charAt(0).toUpperCase();
            } catch (error) {}
            showApp();
            await findOrCreateFile();
        };
        tokenClient.requestAccessToken({prompt: ''});
    }

    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('auth-btn').classList.remove('hidden');
            document.getElementById('signout-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = '×××ª×™×Ÿ...';
            products = [];
            currentUserInitial = '';
        }
    }

    function showApp() {
        document.getElementById('auth-btn').classList.add('hidden');
        document.getElementById('signout-btn').classList.remove('hidden');
        document.getElementById('app-content').classList.remove('hidden');
    }

    async function findOrCreateFile() {
        document.getElementById('status-msg').innerText = '××¡× ×›×¨×Ÿ...';
        
        // ×ª×™×§×•×Ÿ ×¡× ×›×¨×•×Ÿ: ×× ×™×© ID ×™×“× ×™ - ×”×©×ª××© ×‘×• ×™×©×™×¨×•×ª
        if (MANUAL_FILE_ID && MANUAL_FILE_ID.length > 5) {
            driveFileId = MANUAL_FILE_ID;
            await loadFileContent();
            return;
        }

        try {
            const response = await gapi.client.drive.files.list({
                q: `name = '${FILE_NAME}' and trashed = false`,
                fields: 'files(id, name)', spaces: 'drive'
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                driveFileId = files[0].id;
                await loadFileContent();
            } else {
                await createNewFile();
            }
        } catch (err) {
            console.error(err);
            document.getElementById('status-msg').innerText = '×©×’×™××ª ×¨×©×ª';
        }
    }

    async function createNewFile() {
        const initialData = JSON.stringify(initializeDefaultData());
        const metadata = { name: FILE_NAME, mimeType: 'application/json' };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([initialData], { type: 'application/json' }));
        const accessToken = gapi.client.getToken().access_token;
        const fetchResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }), body: form
        });
        const file = await fetchResponse.json();
        driveFileId = file.id;
        products = initializeDefaultData(); 
        renderCatalog();
        document.getElementById('status-msg').innerText = '××—×•×‘×¨ âœ…';
    }

    function initializeDefaultData() {
        const rawItems = [
            { n: "×—×œ×‘ ×ª× ×•×‘×” 3%", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "×§×•×˜×’' 5%", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "×’×‘×™× ×” ×œ×‘× ×” 5%", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "×’×‘×™× ×” ×¦×”×•×‘×” ×¢××§", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "×‘×™×¦×™× L (×ª×‘× ×™×ª)", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "×—×××”", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "××™×œ×§×™", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "×©×× ×ª ××ª×•×§×”", c: "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", fav: true },
            { n: "××œ×¤×¤×•× ×™×", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: true },
            { n: "×¢×’×‘× ×™×•×ª", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: true },
            { n: "×‘×¦×œ ×™×‘×©", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: true },
            { n: "×ª×¤×•×—×™ ××“××”", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: true },
            { n: "×’×–×¨", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: false },
            { n: "×‘× × ×•×ª", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: true },
            { n: "×œ×™××•×Ÿ", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: true },
            { n: "×—×¡×”", c: "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", fav: false },
            { n: "×œ×—× ×¤×¨×•×¡", c: "×œ×—× ×•×××¤×™×", fav: true },
            { n: "×¤×™×ª×•×ª", c: "×œ×—× ×•×××¤×™×", fav: true },
            { n: "×§×¤×” × ××¡", c: "××–×•×•×” ×•×‘×™×©×•×œ", fav: true },
            { n: "×¡×•×›×¨", c: "××–×•×•×” ×•×‘×™×©×•×œ", fav: true },
            { n: "×©×™××•×¨×™ ×˜×•× ×”", c: "×©×™××•×¨×™×", fav: true },
            { n: "×‘××‘×”", c: "×—×˜×™×¤×™× ×•×××ª×§×™×", fav: true },
            { n: "×§×•×œ×” ×–×™×¨×•", c: "××©×§××•×ª ×§×œ×™×", fav: true }
        ];

        return rawItems.map((item, index) => ({
            id: Date.now() + index,
            name: item.n,
            category: item.c,
            isBase: true, 
            isStarred: item.fav, 
            isSelected: false, 
            isBought: false,
            qty: 1,
            creator: ''
        }));
    }

    async function loadFileContent() {
        try {
            document.getElementById('status-msg').innerText = '×˜×•×¢×Ÿ...';
            const response = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
            products = response.result || [];
            if (typeof products !== 'object') products = [];
            products.forEach(p => { 
                if(!p.qty) p.qty = 1; 
                if(p.isBase === undefined) p.isBase = true;
                if(p.isStarred === undefined) p.isStarred = false; 
            });
            refreshView();
            document.getElementById('status-msg').innerText = '××¢×•×“×›×Ÿ âœ…';
        } catch (err) {
            console.error(err);
            document.getElementById('status-msg').innerText = '×©×’×™××”';
        }
    }

    async function saveToDrive() {
        if (!driveFileId) return;
        document.getElementById('status-msg').innerText = '×©×•××¨...';
        const content = JSON.stringify(products);
        const accessToken = gapi.client.getToken().access_token;
        try {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' }),
                body: content
            });
            document.getElementById('status-msg').innerText = '× ×©××¨ âœ…';
        } catch (err) {
            console.error('Error saving', err);
            document.getElementById('status-msg').innerText = '×ª×§×œ×ª ×©××™×¨×”';
        }
    }

    function syncNow() {
        if(driveFileId) loadFileContent();
    }

    function copyFileId() {
        if (driveFileId) {
            navigator.clipboard.writeText(driveFileId).then(() => {
                alert('×”××–×”×” ×”×•×¢×ª×§ ×œ×œ×•×—: ' + driveFileId + '\n×”×“×‘×§ ××•×ª×• ×‘×§×•×“ ×‘××©×ª× ×” MANUAL_FILE_ID ××¦×œ ××©×ª××©×™× ××—×¨×™×.');
            });
        } else {
            alert('×˜×¨× × ×˜×¢×Ÿ ×§×•×‘×¥.');
        }
    }

    // --- Search & View Logic ---
    const CATEGORIES = [
        "×™×¨×§×•×ª ×•×¤×™×¨×•×ª", "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×", "×œ×—× ×•×××¤×™×", "×‘×©×¨ ×•×“×’×™×", "××–×•×•×” ×•×‘×™×©×•×œ", 
        "×©×™××•×¨×™×", "×—×˜×™×¤×™× ×•×××ª×§×™×", "××©×§××•×ª ×§×œ×™×", "××œ×›×•×”×•×œ", "× ×™×§×™×•×Ÿ ×•×‘×™×ª", "×›×œ×œ×™"
    ];

    function handleSearch(val) {
        searchTerm = val.toLowerCase();
        refreshView();
    }

    function toggleCollapseAll() {
        allCollapsed = !allCollapsed;
        CATEGORIES.forEach(cat => {
            categoryState[cat] = allCollapsed;
        });
        refreshView();
    }

    function refreshView() {
        const activeTab = document.querySelector('.tab.active').innerText;
        if(activeTab.includes('×§× ×™×”')) renderShoppingList();
        else if(activeTab.includes('×ª×›× ×•×Ÿ')) renderCatalog();
        else renderBaseList();
    }

    function switchTab(tab) {
        document.getElementById('search-input').value = '';
        searchTerm = '';
        
        document.getElementById('view-catalog').classList.add('hidden');
        document.getElementById('view-shopping').classList.add('hidden');
        document.getElementById('view-base').classList.add('hidden');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        if(tab === 'catalog') {
            document.getElementById('view-catalog').classList.remove('hidden');
            document.querySelectorAll('.tab')[1].classList.add('active');
            renderCatalog();
        } else if (tab === 'shopping') {
            document.getElementById('view-shopping').classList.remove('hidden');
            document.querySelectorAll('.tab')[2].classList.add('active');
            renderShoppingList();
        } else {
            document.getElementById('view-base').classList.remove('hidden');
            document.querySelectorAll('.tab')[0].classList.add('active');
            renderBaseList();
        }
    }

    function toggleCategory(categoryName) {
        categoryState[categoryName] = !categoryState[categoryName];
        refreshView();
    }

    function renderGroupedList(container, itemList, itemTemplateFunc) {
        const groups = {};
        CATEGORIES.forEach(c => groups[c] = []);
        
        const filteredList = searchTerm ? itemList.filter(p => p.name.toLowerCase().includes(searchTerm)) : itemList;

        filteredList.forEach(p => {
            const cat = p.category || '×›×œ×œ×™';
            if(!groups[cat]) groups[cat] = [];
            groups[cat].push(p);
        });

        CATEGORIES.forEach(cat => {
            if(groups[cat].length > 0) {
                const isCollapsed = searchTerm ? false : categoryState[cat];
                const header = document.createElement('div');
                header.className = 'category-header';
                header.onclick = () => toggleCategory(cat);
                header.innerHTML = `
                    <span>${cat}</span>
                    <span class="arrow-icon ${isCollapsed ? 'closed' : ''}">â–¼</span>
                `;
                container.appendChild(header);
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = `category-items-container ${isCollapsed ? 'closed' : ''}`;
                
                groups[cat].sort((a,b) => a.name.localeCompare(b.name, 'he'));

                groups[cat].forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = itemTemplateFunc(p);
                    itemsDiv.appendChild(div);
                });
                container.appendChild(itemsDiv);
            }
        });
    }

    // 1. ×˜××‘ ×§×‘×•×¢×™×
    function renderBaseList() {
        const container = document.getElementById('base-list-container');
        container.innerHTML = '';
        const baseItems = products.filter(p => p.isBase);
        
        renderGroupedList(container, baseItems, (p) => {
            return `
                <div class="item-main" onclick="toggleStar(${p.id})">
                    <div class="star-check ${p.isStarred ? 'active' : ''}">â˜…</div>
                    <span>${p.name}</span>
                </div>
                <button onclick="openEditModal(${p.id})" style="border:none; background:none; cursor:pointer; font-size:18px; color:#ccc; margin-right:5px;">âœ</button>
            `;
        });
    }

    // 2. ×˜××‘ ×ª×›× ×•×Ÿ
    function renderCatalog() {
        const container = document.getElementById('catalog-list-container');
        container.innerHTML = '';
        
        let listToRender;
        if (searchTerm.length > 0) {
            // ×‘×—×™×¤×•×©: ××¦×™×’×™× ×”×›×œ ×›×“×™ ×œ××¤×©×¨ ×‘×—×™×¨×” ××§×‘×•×¢×™×
            listToRender = products.filter(p => p.isSelected || p.isBase);
        } else {
            // ×¨×’×™×œ: ×¨×§ ××” ×©× ×‘×—×¨
            listToRender = products.filter(p => p.isSelected);
        }

        if(listToRender.length === 0 && searchTerm === '') {
            container.innerHTML = '<div style="text-align:center; color:#999; margin-top:30px;">×”×¨×©×™××” ×¨×™×§×”.<br>×”×•×¡×£ ×‘"+" ××• ×™×™×‘× ×"×§×‘×•×¢×™×".</div>';
            return;
        }

        renderGroupedList(container, listToRender, (p) => {
            const creatorBadge = p.creator ? `<span class="user-badge">${p.creator}</span>` : '';
            // ×›×•×›×‘ ×¦×”×•×‘ ×¨×§ ×× ×–×” ××¡×•××Ÿ ×›××•×¢×“×£
            const baseIndicator = p.isStarred ? `<span class="base-indicator">â˜…</span>` : '';

            return `
                <div class="item-main" onclick="toggleSelect(${p.id})">
                    <div class="checkbox ${p.isSelected ? 'checked' : ''}"></div>
                    ${creatorBadge}
                    ${baseIndicator}
                    <span>${p.name}</span>
                </div>
                <div style="display:flex; align-items:center;">
                     <div class="qty-control" onclick="event.stopPropagation()">
                        <button class="qty-btn" onclick="updateQty(${p.id}, -1)">-</button>
                        <input type="text" class="qty-input-manual" value="${p.qty || 1}" onchange="updateQtyManual(${p.id}, this.value)">
                        <button class="qty-btn" onclick="updateQty(${p.id}, 1)">+</button>
                    </div>
                    <button onclick="openEditModal(${p.id})" style="border:none; background:none; cursor:pointer; font-size:18px; color:#ccc; margin-right:5px;">âœ</button>
                </div>
            `;
        });
    }

    // 3. ×˜××‘ ×§× ×™×•×ª
    function renderShoppingList() {
        const container = document.getElementById('shopping-list-container');
        container.innerHTML = '';
        let activeItems = products.filter(p => p.isSelected && !p.isBought);
        let boughtItems = products.filter(p => p.isSelected && p.isBought);
        
        if(activeItems.length === 0 && boughtItems.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; margin-top:30px;">××™×Ÿ ××•×¦×¨×™× ×‘×¨×©×™××” ğŸ‰</div>';
            return;
        }

        const groups = {}; 
        
        const filteredActive = searchTerm ? activeItems.filter(p => p.name.toLowerCase().includes(searchTerm)) : activeItems;
        if(filteredActive.length > 0) {
             filteredActive.forEach(p => {
                 const cat = p.category || '×›×œ×œ×™';
                 if(!groups[cat]) groups[cat] = [];
                 groups[cat].push(p);
             });
             
             CATEGORIES.forEach(cat => {
                if(groups[cat] && groups[cat].length > 0) {
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerHTML = `<span>${cat}</span>`;
                    container.appendChild(header);
                    
                    groups[cat].sort((a,b) => a.name.localeCompare(b.name, 'he'));
                    groups[cat].forEach(p => {
                        const div = document.createElement('div');
                        div.className = `item`;
                        div.innerHTML = `
                            <div class="item-main" onclick="toggleBought(${p.id})">
                                <div class="checkbox"></div>
                                <span>${p.name}</span>
                            </div>
                            <div class="qty-control" style="background:transparent;">
                                <span style="font-weight:bold; color:#3367D6;">${p.qty || 1}</span>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
             });
        }

        // Bought
        const filteredBought = searchTerm ? boughtItems.filter(p => p.name.toLowerCase().includes(searchTerm)) : boughtItems;
        if (filteredBought.length > 0) {
            const cartHeader = document.createElement('div');
            cartHeader.className = 'category-header cart-header';
            cartHeader.innerText = 'ğŸ›’ ××•×¦×¨×™× ×‘×¢×’×œ×”';
            container.appendChild(cartHeader);
            
            filteredBought.sort((a,b) => a.name.localeCompare(b.name, 'he'));
            filteredBought.forEach(p => {
                const div = document.createElement('div');
                div.className = `item bought`;
                div.innerHTML = `
                    <div class="item-main" onclick="toggleBought(${p.id})">
                        <div class="checkbox checked"></div>
                        <span>${p.name}</span>
                    </div>
                    <div class="qty-control" style="background:transparent;">
                        <span style="font-weight:bold; color:#3367D6;">${p.qty || 1}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }

    // --- Actions ---

    function toggleStar(id) {
        const p = products.find(x => x.id === id);
        if(p) { p.isStarred = !p.isStarred; saveToDrive(); refreshView(); }
    }

    function toggleSelect(id) {
        const p = products.find(x => x.id === id);
        if(p) { 
            p.isSelected = !p.isSelected; 
            if(!p.isSelected) p.isBought = false; 
            
            // ×× ×¡×™×× ×• ×‘-V (×”×•×¡×¤× ×• ×œ×ª×›× ×•×Ÿ) - × ×¢×“×›×Ÿ ××ª ×”×™×•×¦×¨ ×œ××™ ×©×¢×©×” ××ª ×”×¤×¢×•×œ×”
            if(p.isSelected) {
                p.creator = currentUserInitial;
            } else {
                // ×× ×”×•×¨×“× ×• V (×”×¡×¨× ×• ××ª×›× ×•×Ÿ) - × ××—×§ ××ª ×”×™×•×¦×¨ (× ×©××¨ ×¨×§ ×‘×××’×¨)
                p.creator = '';
            }
            
            saveToDrive(); 
            refreshView(); 
        }
    }

    function addBaseToPlan() {
        let count = 0;
        products.forEach(p => {
            if (p.isStarred && !p.isSelected) {
                p.isSelected = true;
                count++;
            }
        });
        if (count > 0) {
            saveToDrive();
            alert('×”×•×¡×¤×• ' + count + ' ××•×¦×¨×™× ×œ×¨×©×™××ª ×”×ª×›× ×•×Ÿ');
            switchTab('catalog');
        } else {
            alert('×›×œ ×”××•×¦×¨×™× ×”××¡×•×× ×™× ×›×‘×¨ × ××¦××™× ×‘×ª×›× ×•×Ÿ');
        }
    }

    function toggleBought(id) {
        const p = products.find(x => x.id === id);
        if(p) { p.isBought = !p.isBought; saveToDrive(); setTimeout(() => refreshView(), 200); }
    }

    function updateQty(id, change) {
        const p = products.find(x => x.id === id);
        if(p) {
            let currentVal = parseFloat(p.qty);
            if(isNaN(currentVal)) currentVal = 1;
            let newQty = currentVal + change;
            if(newQty < 1) newQty = 1;
            p.qty = newQty;
            saveToDrive();
            refreshView();
        }
    }

    function updateQtyManual(id, val) {
        const p = products.find(x => x.id === id);
        if(p) { p.qty = val; saveToDrive(); }
    }

    let currentEditId = null;
    function openAddModal() { 
        currentEditId = null; 
        document.getElementById('modal-name-input').value = ''; 
        document.getElementById('modal-delete-btn').classList.add('hidden'); 
        document.getElementById('edit-modal').classList.remove('hidden'); 
        setTimeout(() => document.getElementById('modal-name-input').focus(), 100);
    }
    
    function openEditModal(id) { 
        const p = products.find(x => x.id === id);
        if(!p) return;
        currentEditId = id; 
        document.getElementById('modal-name-input').value = p.name;
        document.getElementById('modal-category-input').value = p.category || '×›×œ×œ×™';
        document.getElementById('modal-delete-btn').classList.remove('hidden'); 
        document.getElementById('edit-modal').classList.remove('hidden'); 
    }
    
    function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }

    function handleModalSave() {
        const name = document.getElementById('modal-name-input').value;
        const cat = document.getElementById('modal-category-input').value;
        if(!name) return;

        if(currentEditId) {
            const p = products.find(x => x.id === currentEditId);
            p.name = name; p.category = cat;
        } else {
            if(products.some(x => x.name === name)) { alert('×”××•×¦×¨ ×§×™×™×'); return; }
            
            const activeTab = document.querySelector('.tab.active').innerText;
            const selectForPlan = !activeTab.includes('×§×‘×•×¢×™×');

            products.push({ 
                id: Date.now(), 
                name: name, 
                category: cat, 
                isSelected: selectForPlan, 
                isBought: false, 
                qty: 1, 
                isBase: true,     
                isStarred: false, // ×œ× ××§×‘×œ ×›×•×›×‘ ××•×˜×•××˜×™×ª ×‘×”×•×¡×¤×”
                creator: selectForPlan ? currentUserInitial : '' 
            });
        }
        saveToDrive();
        closeModal();
        refreshView();
    }

    function deleteItem() {
        if(currentEditId && confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª ××”×××’×¨?')) {
            products = products.filter(x => x.id !== currentEditId);
            saveToDrive();
            closeModal();
            refreshView();
        }
    }

    function resetPlanningList() {
        if(confirm('×”×× ×œ× ×§×•×ª ××ª ×”×¨×©×™××”? (×”××•×¦×¨×™× ×™×™×©××¨×• ×‘"×§×‘×•×¢×™×", ××©×ª××© ×™× ×•×§×”)')) {
            products.forEach(p => {
                p.isSelected = false;
                p.isBought = false;
                p.qty = 1;
                p.creator = ''; 
            });
            saveToDrive();
            refreshView();
        }
    }

    function clearBoughtItems() {
        let changed = false;
        products.forEach(p => {
            if(p.isSelected && p.isBought) {
                p.isSelected = false;
                p.isBought = false;
                p.qty = 1;
                changed = true;
            }
        });
        if(changed) {
            saveToDrive();
            switchTab('catalog');
        } else {
            alert('××™×Ÿ ××•×¦×¨×™× ××¡×•×× ×™× ×©× ×¨×›×©×•');
        }
    }
</script>
</body>
</html>
